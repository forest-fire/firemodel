!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.firemodel={})}(this,function(e){"use strict";var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e,t){return e(t={exports:{}},t.exports),t.exports}function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var d=function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function a(e){try{s(n.next(e))}catch(e){o(e)}}function u(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(a,u)}s((n=n.apply(e,t||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});var h=require("common-types"),l=require("./VerboseError"),f=require("./index"),p=require("pluralize"),y=require("lodash.camelcase"),v=require("serialized-query"),m=require("./util"),g=require("firebase-key");e.baseLogger={log:function(e){return console.log("".concat((void 0).modelName,"/").concat((void 0)._key,": ").concat(e))},warn:function(e){return console.warn("".concat((void 0).modelName,"/").concat((void 0)._key,": ").concat(e))},debug:function(e){"prod"!==(process.env.STAGE||process.env.AWS_STAGE||process.env.ENV)&&console.log("".concat((void 0).modelName,"/").concat((void 0)._key,": ").concat(e))},error:function(e){return console.error("".concat((void 0).modelName,"/").concat((void 0)._key,": ").concat(e))}};var b=function(){function t(r,n,i){var a=this;o(this,t),this._schemaClass=r,this._mockGenerator=function(e){return function(){return a._bespokeMockGenerator?Object.assign({},a._defaultGenerator(e)(),a._bespokeMockGenerator(e)()):a._defaultGenerator(e)()}},this._defaultGenerator=function(e){return function(){return{createdAt:new Date(e.faker.date.past()).toISOString(),lastUpdated:(new Date).toISOString()}}},this._db=n,t.defaultDb||(t.defaultDb=n),this.logger=i||e.baseLogger,this._schema=new this.schemaClass}return u(t,[{key:"getRecord",value:function(e){return d(this,void 0,void 0,function*(){return yield f.Record.get(this._schemaClass,e)})}},{key:"getAll",value:function(e){return d(this,void 0,void 0,function*(){var t=new f.List(this);return e?t.load(e):t.load(this.dbPath)})}},{key:"findRecord",value:function(e,t){return d(this,void 0,void 0,function*(){var r=this._findBuilder(e,t,!0),n=yield this.db.getList(r);if(n.length>0){var i=n.pop();return f.Record.get(this._schemaClass,i.id)}throw h.createError("not-found","Not Found: didn't find any \"".concat(this.pluralName,'" which had "').concat(e,'" set to "').concat(t,'"; note the path in the database which was searched was "').concat(this.dbPath,'".'))})}},{key:"findAll",value:function(e,t){return d(this,void 0,void 0,function*(){var r,n=this._findBuilder(e,t);try{r=yield this.db.getList(n)}catch(e){throw console.log("Error attempting to findAll() in Model.",e),h.createError("model/findAll","\nFailed getting via getList() with query"+JSON.stringify(n,null,2),e)}return new f.List(this,r)})}},{key:"set",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(this,void 0,void 0,function*(){if(!e.id)throw h.createError("set/no-id",'Attempt to set "'.concat(this.dbPath,'" in database but record had no "id" property.'));var r=this.now();return e=Object.assign({},e,{lastUpdated:r}),t=Object.assign({},t,{properties:Object.keys(e)}),yield this.crud("set",r,m.slashNotation(this.dbPath,e.id),e,t)})}},{key:"push",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(this,void 0,void 0,function*(){var r=this.now(),n=g.key();e=Object.assign({},e,{lastUpdated:r,createdAt:r}),t=Object.assign({},t,{properties:Object.keys(e)});yield this.crud("push",r,m.slashNotation(this.dbPath,n),e,t);return f.Record.get(this._schemaClass,n)})}},{key:"update",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return d(this,void 0,void 0,function*(){var n=this.now();r=Object.assign({auditInfo:r},{updatedProperties:Object.keys(t)}),t=Object.assign({},t,{lastUpdated:n}),yield this.crud("update",n,m.slashNotation(this.dbPath,e),t,r)})}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return d(this,void 0,void 0,function*(){if(!e){var n=new Error("Trying to call remove(id) on a ".concat(this.modelName," Model class can not be done when ID is undefined!"));throw n.name="NotAllowed",n}var i,o=this.now();return t&&(i=yield this._db.getValue(m.slashNotation(this.dbPath,e))),yield this.crud("remove",o,e.match(this.dbPath)?e:m.slashNotation(this.dbPath,e),null,r),t?i:void 0})}},{key:"getAuditTrail",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return d(this,void 0,void 0,function*(){var r=e.since,n=e.last,i="".concat(t.auditBase,"/").concat(this.pluralName),o=v.SerializedQuery.path(i);if(r){var a=new Date(r).toISOString();o=o.orderByChild("when").startAt(a)}return n&&(o=o.limitToLast(n)),this.db.getList(o)})}},{key:"audit",value:function(e,r,n,i){return d(this,void 0,void 0,function*(){var o=m.slashNotation(t.auditBase,this.pluralName);return this.db.push(o,{crud:e,when:r,key:n,info:i})})}},{key:"crud",value:function(e,r,n,i,o){return d(this,void 0,void 0,function*(){var a=this,u=this._schema.META.audit;m.slashNotation(t.auditBase,this.pluralName,n);switch(u&&(console.log("auditing: ",e),yield this.audit(e,r,n,o)),e){case"set":return this.db.set(n,i);case"update":return this.db.update(n,i);case"push":return this.db.set(n,i).then(function(){return a.db.ref(n)});case"remove":return this.db.remove(n);default:throw new l.VerboseError({code:"unknown-operation",message:'The operation "'.concat(e,'" is not known!'),module:"crud"})}})}},{key:"_findBuilder",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="=";t instanceof Array&&(n=t[0],t=t[1]);var i=v.SerializedQuery.path(this.dbPath).orderByChild(e);switch(r&&(i=i.limitToFirst(1)),n){case"=":return i.equalTo(t);case">":return i.startAt(t);case"<":return i.endAt(t);default:throw new l.VerboseError({code:"invalid-operation",message:'Invalid comparison operater "'.concat(n,'" used in find query'),module:"findXXX"})}}},{key:"generate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.db.mock.queueSchema(this.modelName,e,t),this.db.mock.generate()}},{key:"now",value:function(){return Date.now()}},{key:"modelName",get:function(){return y(this._schema.constructor.name)}},{key:"pluralName",get:function(){return this._pluralName?this._pluralName:p.plural(this.modelName)},set:function(e){this._pluralName=e}},{key:"mockGenerator",set:function(e){this._bespokeMockGenerator=e}},{key:"schemaClass",get:function(){return this._schemaClass}},{key:"db",get:function(){return this._db}},{key:"schema",get:function(){return this._schema}},{key:"dbPath",get:function(){return[this._schema.META.dbOffset,this.pluralName].join(".")}},{key:"localPath",get:function(){return[this._schema.META.localOffset,this.pluralName].join(".")}},{key:"relationships",get:function(){return this._schema.META.relationships}},{key:"properties",get:function(){return this._schema.META.properties}},{key:"pushKeys",get:function(){return this._schema.META?this._schema.META.pushKeys:[]}}],[{key:"create",value:function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new t(r,n.db||t.defaultDb,n.logger||e.baseLogger)}}]),t}();b.defaultDb=null,b.auditBase="logging/audit_logs",e.default=b;var w=Object.freeze({});Object.defineProperty(e,"__esModule",{value:!0}),require("reflect-metadata");var _=require("./decorator");e.constrainedProperty=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _.propertyDecorator(Object.assign({},e,{isRelationship:!1,isProperty:!0}),"property")},e.constrain=function(e,t){return _.propertyDecorator(s({},e,t))},e.desc=function(e){return _.propertyDecorator({desc:e})},e.min=function(e){return _.propertyDecorator({min:e})},e.max=function(e){return _.propertyDecorator({max:e})},e.length=function(e){return _.propertyDecorator({length:e})},e.property=_.propertyDecorator({isRelationship:!1,isProperty:!0},"property"),e.pushKey=_.propertyDecorator({pushKey:!0},"property");var k,O=Object.freeze({});!function(e){!function(r){var n="object"==typeof t?t:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),i=o(e);function o(e,t){return function(r,n){"function"!=typeof e[r]&&Object.defineProperty(e,r,{configurable:!0,writable:!0,value:n}),t&&t(r,n)}}void 0===n.Reflect?n.Reflect=e:i=o(n.Reflect,i),function(e){var t=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",i=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,u=!o&&!a,s={create:o?function(){return N(Object.create(null))}:a?function(){return N({__proto__:null})}:function(){return N({})},has:u?function(e,r){return t.call(e,r)}:function(e,t){return t in e},get:u?function(e,r){return t.call(e,r)?e[r]:void 0}:function(e,t){return e[t]}},c=Object.getPrototypeOf(Function),d="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,h=d||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?function(){var e={},t=[],r=function(){function e(e,t,r){this._index=0,this._keys=e,this._values=t,this._selector=r}return e.prototype["@@iterator"]=function(){return this},e.prototype[i]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var r=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var r=this._find(e,!0);return this._values[r]=t,this},t.prototype.delete=function(t){var r=this._find(t,!1);if(r>=0){for(var n=this._keys.length,i=r+1;i<n;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new r(this._keys,this._values,n)},t.prototype.values=function(){return new r(this._keys,this._values,o)},t.prototype.entries=function(){return new r(this._keys,this._values,a)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[i]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function n(e,t){return e}function o(e,t){return t}function a(e,t){return[e,t]}}():Map,l=d||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?function(){function e(){this._map=new h}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[i]=function(){return this.keys()},e}():Set,f=new(d||"function"!=typeof WeakMap?function(){var e=16,r=s.create(),n=i();return function(){function e(){this._key=i()}return e.prototype.has=function(e){var t=o(e,!1);return void 0!==t&&s.has(t,this._key)},e.prototype.get=function(e){var t=o(e,!1);return void 0!==t?s.get(t,this._key):void 0},e.prototype.set=function(e,t){var r=o(e,!0);return r[this._key]=t,this},e.prototype.delete=function(e){var t=o(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=i()},e}();function i(){var e;do{e="@@WeakMap@@"+u()}while(s.has(r,e));return r[e]=!0,e}function o(e,r){if(!t.call(e,n)){if(!r)return;Object.defineProperty(e,n,{value:s.create()})}return e[n]}function a(e,t){for(var r=0;r<t;++r)e[r]=255*Math.random()|0;return e}function u(){var t=function(e){if("function"==typeof Uint8Array)return"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):a(new Uint8Array(e),e);return a(new Array(e),e)}(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var r="",n=0;n<e;++n){var i=t[n];4!==n&&6!==n&&8!==n||(r+="-"),i<16&&(r+="0"),r+=i.toString(16).toLowerCase()}return r}}():WeakMap);function p(e,t,r){var n=f.get(e);if(w(n)){if(!r)return;n=new h,f.set(e,n)}var i=n.get(t);if(w(i)){if(!r)return;i=new h,n.set(t,i)}return i}function y(e,t,r){var n=p(t,r,!1);return!w(n)&&!!n.has(e)}function v(e,t,r){var n=p(t,r,!1);if(!w(n))return n.get(e)}function m(e,t,r,n){var i=p(r,n,!0);i.set(e,t)}function g(e,t){var r=[],n=p(e,t,!1);if(w(n))return r;for(var o=n.keys(),a=function(e){var t=E(e,i);if(!j(t))throw new TypeError;var r=t.call(e);if(!k(r))throw new TypeError;return r}(o),u=0;;){var s=M(a);if(!s)return r.length=u,r;var c=s.value;try{r[u]=c}catch(e){try{x(a)}finally{throw e}}u++}}function b(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function w(e){return void 0===e}function _(e){return null===e}function k(e){return"object"==typeof e?null!==e:"function"==typeof e}function O(e,t){switch(b(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var r=3===t?"string":5===t?"number":"default",i=E(e,n);if(void 0!==i){var o=i.call(e,r);if(k(o))throw new TypeError;return o}return function(e,t){if("string"===t){var r=e.toString;if(j(r)){var n=r.call(e);if(!k(n))return n}var i=e.valueOf;if(j(i)){var n=i.call(e);if(!k(n))return n}}else{var i=e.valueOf;if(j(i)){var n=i.call(e);if(!k(n))return n}var o=e.toString;if(j(o)){var n=o.call(e);if(!k(n))return n}}throw new TypeError}(e,"default"===r?"number":r)}function P(e){var t=O(e,3);return"symbol"==typeof t?t:function(e){return""+e}(t)}function A(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function j(e){return"function"==typeof e}function T(e){return"function"==typeof e}function E(e,t){var r=e[t];if(void 0!==r&&null!==r){if(!j(r))throw new TypeError;return r}}function M(e){var t=e.next();return!t.done&&t}function x(e){var t=e.return;t&&t.call(e)}function S(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===c)return t;if(t!==c)return t;var r=e.prototype,n=r&&Object.getPrototypeOf(r);if(null==n||n===Object.prototype)return t;var i=n.constructor;return"function"!=typeof i?t:i===e?t:i}function N(e){return e.__=void 0,delete e.__,e}e("decorate",function(e,t,r,n){if(w(r)){if(!A(e))throw new TypeError;if(!T(t))throw new TypeError;return function(e,t){for(var r=e.length-1;r>=0;--r){var n=e[r],i=n(t);if(!w(i)&&!_(i)){if(!T(i))throw new TypeError;t=i}}return t}(e,t)}if(!A(e))throw new TypeError;if(!k(t))throw new TypeError;if(!k(n)&&!w(n)&&!_(n))throw new TypeError;return _(n)&&(n=void 0),r=P(r),function(e,t,r,n){for(var i=e.length-1;i>=0;--i){var o=e[i],a=o(t,r,n);if(!w(a)&&!_(a)){if(!k(a))throw new TypeError;n=a}}return n}(e,t,r,n)}),e("metadata",function(e,t){return function(r,n){if(!k(r))throw new TypeError;if(!w(n)&&!function(e){switch(b(e)){case 3:case 4:return!0;default:return!1}}(n))throw new TypeError;m(e,t,r,n)}}),e("defineMetadata",function(e,t,r,n){if(!k(r))throw new TypeError;w(n)||(n=P(n));return m(e,t,r,n)}),e("hasMetadata",function(e,t,r){if(!k(t))throw new TypeError;w(r)||(r=P(r));return function e(t,r,n){var i=y(t,r,n);if(i)return!0;var o=S(r);if(!_(o))return e(t,o,n);return!1}(e,t,r)}),e("hasOwnMetadata",function(e,t,r){if(!k(t))throw new TypeError;w(r)||(r=P(r));return y(e,t,r)}),e("getMetadata",function(e,t,r){if(!k(t))throw new TypeError;w(r)||(r=P(r));return function e(t,r,n){var i=y(t,r,n);if(i)return v(t,r,n);var o=S(r);if(!_(o))return e(t,o,n);return}(e,t,r)}),e("getOwnMetadata",function(e,t,r){if(!k(t))throw new TypeError;w(r)||(r=P(r));return v(e,t,r)}),e("getMetadataKeys",function(e,t){if(!k(e))throw new TypeError;w(t)||(t=P(t));return function e(t,r){var n=g(t,r);var i=S(t);if(null===i)return n;var o=e(i,r);if(o.length<=0)return n;if(n.length<=0)return o;var a=new l;var u=[];for(var s=0,c=n;s<c.length;s++){var d=c[s],h=a.has(d);h||(a.add(d),u.push(d))}for(var f=0,p=o;f<p.length;f++){var d=p[f],h=a.has(d);h||(a.add(d),u.push(d))}return u}(e,t)}),e("getOwnMetadataKeys",function(e,t){if(!k(e))throw new TypeError;w(t)||(t=P(t));return g(e,t)}),e("deleteMetadata",function(e,t,r){if(!k(t))throw new TypeError;w(r)||(r=P(r));var n=p(t,r,!1);if(w(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var i=f.get(t);return i.delete(r),i.size>0||(f.delete(t),!0)})}(i)}()}(k||(k={}));Object.defineProperty(e,"__esModule",{value:!0}),require("reflect-metadata");var P=require("lodash.set"),A=require("lodash.get");function j(e,t,r){Array.isArray(A(e,t))?A(e,t).push(r):P(e,t,[r])}var T={},E={};function M(e){return c(T[e.constructor.name]).concat(c(T.BaseSchema.map(function(e){return Object.assign({},e,{isBaseSchema:!0})})))}e.propertyDecorator=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;return function(r,n){var i=Reflect.getMetadata("design:type",r,n),o=Object.assign({},Reflect.getMetadata(n,r),{type:i.name},e);Reflect.defineMetadata(n,o,r);(void 0)[n];e.isProperty&&j(T,r.constructor.name,t?Object.assign({},o,s({},t,n)):o),e.isRelationship&&j(E,r.constructor.name,t?Object.assign({},o,s({},t,n)):o)}},e.getProperties=M,e.getRelationships=function(e){return E[e.constructor.name]},e.getPushKeys=function(e){return M(e).filter(function(e){return e.pushKey}).map(function(e){return e.property})};var x=Object.freeze({}),S=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.hasMany=function(e){return x.propertyDecorator({isRelationship:!0,isProperty:!1,relType:"hasMany"},"property")},t.ownedBy=function(e){return x.propertyDecorator({isRelationship:!0,isProperty:!1,relType:"ownedBy"},"property")},t.inverse=function(e){return x.propertyDecorator({inverseProperty:e})}});r(S);S.hasMany,S.ownedBy,S.inverse;var N=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.schema=function(e){return function(t){var r=t,n=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=Reflect.construct(r,n);return Reflect.defineProperty(o,"META",{get:function(){return Object.assign({},e,{property:(t=o,function(e){return Reflect.getMetadata(e,t)})},{properties:x.getProperties(o)},{relationships:x.getRelationships(o)},{pushKeys:x.getPushKeys(o)},{audit:!!e.audit&&e.audit});var t},set:function(){throw new Error("The meta property can only be set with the @schema decorator!")},configurable:!1,enumerable:!1}),o};return n.prototype=r.prototype,n}}});r(N);N.schema;var R=function(e,t,r,n){var o,a=arguments.length,u=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":i(Reflect))&&"function"==typeof Reflect.decorate)u=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(u=(a<3?o(u):a>3?o(t,r,u):o(t,r))||u);return a>3&&u&&Object.defineProperty(t,r,u),u},z=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":i(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(e,"__esModule",{value:!0});var D=require("./decorators/property");!function(e){e.keys="keys",e.lazy="lazy",e.inline="inline"}(e.RelationshipPolicy||(e.RelationshipPolicy={})),function(e){e.hasMany="hasMany",e.belongsTo="belongsTo"}(e.RelationshipCardinality||(e.RelationshipCardinality={}));var B=function(){function e(){o(this,e)}return u(e,[{key:"toString",value:function(){var e=this,t={};return this.META.properties.map(function(r){t[r.property]=e[r.property]}),JSON.stringify(t)}}]),e}();R([D.property,z("design:type",String)],B.prototype,"id",void 0),R([D.property,z("design:type",Number)],B.prototype,"lastUpdated",void 0),R([D.property,z("design:type",Number)],B.prototype,"createdAt",void 0),e.BaseSchema=B;var C=Object.freeze({}),K=function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function a(e){try{s(n.next(e))}catch(e){o(e)}}function u(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(a,u)}s((n=n.apply(e,t||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});var q=require("common-types"),L=require("./model"),U=require("firebase-key"),I=function(){function e(t){o(this,e),this._model=t,this._existsOnDB=!1,this._writeOperations=[],this._data=new t.schemaClass}return u(e,[{key:"initialize",value:function(e){return K(this,void 0,void 0,function*(){var t=this;Object.keys(e).map(function(r){t._data[r]=e[r]});var r=this.META.relationships;(r||[]).filter(function(e){return"ownedBy"===e.relType}).map(function(e){return e.property});(r||[]).filter(function(e){return"hasMany"===e.relType}).map(function(e){return e.property}).map(function(e){t._data[e]||(t._data[e]={})});var n=(new Date).getTime();this._data.lastUpdated||(this._data.lastUpdated=n),this._data.createdAt||(this._data.createdAt=n),this.id||this._save()})}},{key:"load",value:function(e){return K(this,void 0,void 0,function*(){if(!this.db){var t=new Error("The attempt to load data into a Record requires that the DB property be initialized first!");throw t.name="NoDatabase",t}this._data.id=e;var r=yield this.db.getRecord(this.dbPath);if(!r||!r.id)throw new Error('Unknown Key: the key "'.concat(e,'" was not found in Firebase at "').concat(this.dbPath,'".'));return this.initialize(r),this})}},{key:"update",value:function(e){return K(this,void 0,void 0,function*(){if(!this.data.id||!this._existsOnDB)throw new Error('Invalid Operation: you can not update a record which doesn\'t have an "id" or which has never been saved to the database');return this.db.update(this.dbPath,e)})}},{key:"pushKey",value:function(e,t){return K(this,void 0,void 0,function*(){if(-1===this.META.pushKeys.indexOf(e))throw q.createError("invalid-operation/not-pushkey",'Invalid Operation: you can not push to property "'.concat(e,'" as it has not been declared a pushKey property in the schema'));if(!this.existsOnDB)throw q.createError("invalid-operation/not-on-db",'Invalid Operation: you can not push to property "'.concat(e,'" before saving the record to the database'));var r=U.key(),n=this.get(e)||{},i=Object.assign({},n,s({},r,t));this.set(e,i);var o=this.db.multiPathSet("".concat(this.dbPath,"/"));o.add({path:"lastUpdated",value:(new Date).getTime()}),o.add({path:"".concat(e,"/").concat(r),value:t});try{yield o.execute()}catch(e){throw q.createError("multi-path/write-error","",e)}return r})}},{key:"updateProps",value:function(e){return K(this,void 0,void 0,function*(){var t=this,r=this.db.multiPathSet(this.dbPath);Object.keys(e).map(function(n){if("object"===i(e[n])){var o=t.get(n);e[n]=Object.assign({},o,e[n])}else"lastUpdated"!==n&&r.add({path:n,value:e[n]});t.set(n,e[n])});var n=(new Date).getTime();r.add({path:"lastUpdated",value:n}),this._data.lastUpdated=n;try{yield r.execute()}catch(e){throw q.createError("UpdateProps","An error occurred trying to update ".concat(this._model.modelName,":").concat(this.id),e)}})}},{key:"addHasMany",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return K(this,void 0,void 0,function*(){if("hasMany"!==this.META.property(e).relType){var n=new Error('The property "'.concat(e,'" does NOT have a "hasMany" relationship on ').concat(this.modelName));throw n.name="InvalidRelationship",n}"object"===i(this.data[e])&&this.data[e][t]?console.warn('The fk of "'.concat(t,'" already exists in "').concat(this.modelName,".").concat(e,'"!')):yield this.db.multiPathSet(this.dbPath).add({path:"".concat(e,"/").concat(t,"/"),value:r}).add({path:"lastUpdated",value:(new Date).getTime()}).execute()})}},{key:"set",value:function(e,t){return K(this,void 0,void 0,function*(){this._data[e]=t,yield this.db.multiPathSet(this.dbPath).add({path:"".concat(e,"/"),value:t}).add({path:"lastUpdated/",value:(new Date).getTime()}).execute()})}},{key:"get",value:function(e){return this.data[e]}},{key:"toString",value:function(){return"Record::".concat(this.modelName,"@").concat(this.id||"undefined")}},{key:"toJSON",value:function(){return{dbPath:this.dbPath,modelName:this.modelName,pluralName:this.pluralName,key:this.id,localPath:this.localPath,data:this.data.toString()}}},{key:"_save",value:function(){return K(this,void 0,void 0,function*(){if(this.id){var e=new Error("Saving after ID is set is not allowed [ ".concat(this.id," ]"));throw e.name="InvalidSave",e}return this.id=U.key(),yield this.db.set(this.dbPath,this.data),this})}},{key:"data",get:function(){return this._data}},{key:"isDirty",get:function(){return this._writeOperations.length>0}},{key:"META",get:function(){return this._model.schema.META}},{key:"db",get:function(){return this._model.db}},{key:"pluralName",get:function(){return this._model.pluralName}},{key:"pushKeys",get:function(){return this._model.schema.META.pushKeys}},{key:"dbPath",get:function(){if(!this.data.id)throw q.createError("record/invalid-path",'Invalid Record Path: you can not ask for the dbPath before setting an "id" property.');return[this.data.META.dbOffset,this.pluralName,this.data.id].join("/")}},{key:"modelName",get:function(){return this.data.constructor.name.toLowerCase()}},{key:"id",get:function(){return this.data.id},set:function(e){if(this.data.id){var t=new Error("You may not re-set the ID of a record [ ".concat(this.data.id," â†’ ").concat(e," ]."));throw t.name="NotAllowed",t}this._data.id=e}},{key:"dbOffset",get:function(){return this.data.META.dbOffset}},{key:"localPath",get:function(){if(!this.data.id)throw new Error('Invalid Path: you can not ask for the dbPath before setting an "id" property.');return[this.data.META.localOffset,this.pluralName,this.data.id].join("/")}},{key:"existsOnDB",get:function(){return!(!this.data||!this.data.id)}}],[{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new e(L.default.create(t,r),r)}},{key:"add",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return K(this,void 0,void 0,function*(){var i=e.create(t,n);return yield i.initialize(r),i})}},{key:"get",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return K(this,void 0,void 0,function*(){var i=e.create(t,n);return yield i.load(r),i})}}]),e}();e.Record=I;var F=Object.freeze({}),G=function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function a(e){try{s(n.next(e))}catch(e){o(e)}}function u(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(a,u)}s((n=n.apply(e,t||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});var Q=require("./index"),V=require("serialized-query"),W=require("./model"),J=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];o(this,e),this._model=t,this._data=r}return u(e,[{key:"filter",value:function(t){return new e(this._model,this._data.filter(t))}},{key:"find",value:function(e){var t=this._data.filter(e);return t.length>0?Q.Record.add(this._model.schemaClass,t[0]):null}},{key:"map",value:function(e){return this._data.map(e)}},{key:"get",value:function(e){var t=this.filter(function(t){return t.id===e});if(0===t.length){var r=new Error('Could not find "'.concat(e,'" in list of ').concat(this._model.pluralName));throw r.name="NotFound",r}var n=new Q.Record(this._model);return n.initialize(t.data[0]),n}},{key:"getModel",value:function(e){return this.get(e).data}},{key:"load",value:function(e){return G(this,void 0,void 0,function*(){if(!this.db){var t=new Error("The attempt to load data into a List requires that the DB property be initialized first!");throw t.name="NoDatabase",t}return this._data=yield this.db.getList(e),this})}},{key:"length",get:function(){return this._data.length}},{key:"db",get:function(){return this._model.db}},{key:"modelName",get:function(){return this._model.modelName}},{key:"pluralName",get:function(){return this._model.pluralName}},{key:"dbPath",get:function(){return[this.meta.dbOffset,this.pluralName].join("/")}},{key:"localPath",get:function(){return[this.meta.localOffset,this.pluralName].join("/")}},{key:"meta",get:function(){return this._model.schema.META}},{key:"data",get:function(){return this._data}}],[{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new e(W.default.create(t,r))}},{key:"from",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(this,void 0,void 0,function*(){var i=W.default.create(t,n);r.setPath(i.dbPath);var o=e.create(t,n);return yield o.load(r),o})}},{key:"all",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return G(this,void 0,void 0,function*(){var n=(new V.SerializedQuery).orderByChild("lastUpdated");return yield e.from(t,n,r)})}},{key:"first",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(this,void 0,void 0,function*(){var i=(new V.SerializedQuery).orderByChild("createdAt").limitToLast(r);return yield e.from(t,i,n)})}},{key:"recent",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(this,void 0,void 0,function*(){var i=(new V.SerializedQuery).orderByChild("lastUpdated").limitToFirst(r);return yield e.from(t,i,n)})}},{key:"inactive",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(this,void 0,void 0,function*(){var i=(new V.SerializedQuery).orderByChild("lastUpdated").limitToLast(r);return yield e.from(t,i,n)})}},{key:"last",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(this,void 0,void 0,function*(){var i=(new V.SerializedQuery).orderByChild("createdAt").limitToFirst(r);return yield e.from(t,i,n)})}},{key:"where",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return G(this,void 0,void 0,function*(){var o="=",a=n;Array.isArray(n)&&(a=n[1],o=n[0]);var u=(new V.SerializedQuery).orderByChild(r).where(o,a);return yield e.from(t,u,i)})}}]),e}();e.List=J;var X=Object.freeze({}),Y="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz";function $(e){for(var t=0,r=0;r<8;++r){var n=Y.indexOf(e.charAt(r));if(-1===n)throw new Error("Unexpected character '"+e.charAt(r)+"'.");t=64*t+n}return t}function H(e,t){var r="";if("function"==typeof e.repeat)r=e.repeat(t);else if(t>0){for(;t>1;)1&t&&(r+=e),t>>=1,e+=e;r+=e}return r}var Z=0;var ee=Object.freeze({date:function(e){return new Date($(e))},decode:function(e){return e.replace(/!([0-9a-f]{2})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))})},decodeLexicographic:function(e){var t=0;if(e.charAt(0)>"_")for(var r=1;r<e.length;r++)t*=Y.length,t+=Y.indexOf(e.charAt(r));else{for(r=1;r<e.length;r++)t*=Y.length,t+=Y.length-1-Y.indexOf(e.charAt(r));t=-t}return t},decrement:function(e){return e.replace(/[^-]-*$/,function(e){var t=Y.indexOf(e.charAt(0));if(-1===t)throw new Error("Unexpected character '"+e.charAt(0)+"'.");return Y.charAt(t-1)+H("z",e.length-1)})},encode:function(e){return e.replace(/[\/\.\$\[\]#!]/g,function(e){return"!"+e.charCodeAt(0).toString(16).toUpperCase()})},encodeLexicographic:function(e){var t="";if(0===e)t="a-";else if(e>0){for(;e>0;){var r=e%Y.length;t=Y.charAt(r)+t,e-=r,e/=Y.length}t=Y.charAt(t.length+37)+t}else{for(e=-e;e>0;)r=e%Y.length,t=Y.charAt(Y.length-1-r)+t,e-=r,e/=Y.length;t=Y.charAt(37-t.length)+t}return t},increment:function(e){return e.replace(/[^z]z*$/,function(e){var t=Y.indexOf(e.charAt(0));if(-1===t)throw new Error("Unexpected character '"+e.charAt(0)+"'.");return Y.charAt(t+1)+H("-",e.length-1)})},key:function(e,t){void 0===e&&((e=Date.now())<=Z&&(e=Z+1),Z=e),e instanceof Date&&(e=e.getTime());for(var r=new Array(9),n=7;n>=0;--n)r[n]=Y.charAt(e%64),e=Math.floor(e/64);if(0!==e)throw new Error("Unexpected timestamp.");switch(t){case"max":r[8]="zzzzzzzzzzzz";break;case"min":r[8]="------------";break;default:r[8]=function(e,t){var r=[];for(t|=0;t;){var n=Math.random()*e.length|0;r.push(e.charAt(n)),t-=1}return r.join("")}(Y,12)}return r.join("")},resetLastTimestamp:function(){Z=0},milliseconds:$}),te=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=w.default,t.property=O.property,t.pushKey=O.pushKey,t.constrainedProperty=O.constrainedProperty,t.constrain=O.constrain,t.min=O.min,t.max=O.max,t.length=O.length,t.desc=O.desc,t.hasMany=S.hasMany,t.ownedBy=S.ownedBy,t.inverse=S.inverse,t.schema=N.schema;var r=w;t.Model=r.default,t.BaseSchema=C.BaseSchema,t.RelationshipPolicy=C.RelationshipPolicy,t.RelationshipCardinality=C.RelationshipCardinality,t.Record=F.Record,t.List=X.List,t.fbKey=ee.key}),re=r(te),ne=te.property,ie=te.pushKey,oe=te.constrainedProperty,ae=te.constrain,ue=te.min,se=te.max,ce=te.length,de=te.desc,he=te.hasMany,le=te.ownedBy,fe=te.inverse,pe=te.schema,ye=te.Model,ve=te.BaseSchema,me=te.RelationshipPolicy,ge=te.RelationshipCardinality,be=te.Record,we=te.List,_e=te.fbKey;e.default=re,e.property=ne,e.pushKey=ie,e.constrainedProperty=oe,e.constrain=ae,e.min=ue,e.max=se,e.length=ce,e.desc=de,e.hasMany=he,e.ownedBy=le,e.inverse=fe,e.schema=pe,e.Model=ye,e.BaseSchema=ve,e.RelationshipPolicy=me,e.RelationshipCardinality=ge,e.Record=be,e.List=we,e.fbKey=_e,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=firemodel.min.js.map
